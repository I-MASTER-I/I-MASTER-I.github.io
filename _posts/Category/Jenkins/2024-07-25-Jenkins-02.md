---
layout:     BLACKCODE
title:      "Jenkins Job Pipeline 구성"
subtitle:   ""
description: ""
date:       2024-07-25 01:10:00
author:     "MADness"
header-img: "assets/owner/hero/home-bg.jpg"
header-video: "assets/video/metrix.mp4"
thumbnail: /assets/owner/blog/thumbs/thumb01.png
tags: [Jenkins]
category: [Jenkins]
# comments: false
# share: false
---

# 환경 구성
- SpringBoot 3.4
- Gradle
- war

---
<br><br><br>

# Jenkins Pipeline 설정
## Jenkinsfile 작성
프로젝트 루트 디렉토리에 Jenkinsfile을 작성합니다. 아래는 Gradle을 사용하는 기본적인 Jenkinsfile 예시입니다:

```shell
pipeline {
    agent any

    tools {
        gradle 'Gradle 6.8.3' // Gradle 설치 경로 설정
    }

    // 환경변수 저장
    environment {
        DOCKER_IMAGE = 'iiblackcode/springboot-6060'
        REMOTE_DIR = '/home/master/' // 원격 서버의 대상 디렉토리
        REMOTE_USER = 'master' // 원격 서버의 사용자 이름
        REMOTE_HOST = '52.141.27.193' // 원격 서버의 주소
        SSH_CREDENTIALS_ID = 'master' // Jenkins 자격 증명 ID
    }

    stages {
        stage('Checkout') {
            steps {
                git 'http://52.231.108.38/svn/springboot'
            }
        }
        stage('Build') {
            steps {
                sh './gradlew clean build'
            }
        }
        stage('Test') {
            steps {
                sh './gradlew test'
            }
        }
        
    }
    stages('test') {
        steps {
            script {
                dir('was/SpringBoot') {
                    echo "현재 디렉토리 출력"
                    sh 'pwd'
                    
                    echo "현재 사용자 확인"
                    sh 'whoami'
                }
            }
        }
    }
    post {
        success {
            echo 'Build completed successfully!'
        }
        failure {
            echo 'Build failed!'
        }
    }
}
```
---
# 작업 테스트중
```shell
pipeline {
    agent any

    // 환경변수 저장
    environment {
        DOCKER_IMAGE = 'iiblackcode/springboot-6060'
        REMOTE_DIR = '/home/master' // 원격 서버의 대상 디렉토리
        REMOTE_USER = 'master' // 원격 서버의 사용자 이름
        REMOTE_HOST = '52.141.27.193' // 원격 서버의 주소
        SSH_CREDENTIALS_ID = 'master' // Jenkins 자격 증명 ID
    }

    stages {
        stage('Jenkins Server Build') {
            steps {
                // 현재 작업 디렉토리 확인
                sh 'pwd'
                // 디렉토리 변경 후 파일 확인
                dir('demo-war') {
                    sh '''
                        pwd
                        ls -l
                        
                        # windows에서 작업하는 경우 gradlew파일이 text로 인식해서 올바른 형식 변환
                        dos2unix gradlew
                        chmod +x gradlew
                        ./gradlew clean build --info
                    '''
                }
            }
        }
        stage('Test') {
            steps {
                dir('demo-war') {
                    sh './gradlew test'
                }
            }
        }
        stage('Deploy to Remote Server') {
            steps {
                script {
                    def warFile = 'demo-war/build/libs/*.war'
                    def remoteFilePath = "${REMOTE_DIR}/was/Jenkins_Pipeline_Test/*.war"

                    // WAR 파일을 원격 서버로 전송
                    sh """
                        scp -o StrictHostKeyChecking=no -i ${SSH_CREDENTIALS_ID} ${warFile} ${REMOTE_USER}@${REMOTE_HOST}:${remoteFilePath}
                    """
                    
                    // 원격 서버에서 배포 명령 실행
                    sh """
                        ssh -o StrictHostKeyChecking=no -i ${SSH_CREDENTIALS_ID} ${REMOTE_USER}@${REMOTE_HOST} '
                            echo "원격 서버에서 배포 작업 실행"
                            # 기존 애플리케이션 중지 (필요한 경우)
                            # sudo systemctl stop your-service

                            # 애플리케이션 배포
                            sudo cp ${remoteFilePath} /path/to/deploy/

                            # 기존 애플리케이션 시작 (필요한 경우)
                            # sudo systemctl start your-service
                        '
                    """
                }
            }
        }
    }

    post {
        success {
            echo 'Build completed successfully!'
        }
        failure {
            echo 'Build failed!'
        }
    }
}
```

위 스크립트를 통해 다음과 같은 디렉토리에 파일을 생성

```shell
master@master:~/was/Jenkins_Pipeline_Test$ pwd
/home/master/was/Jenkins_Pipeline_Test
master@master:~/was/Jenkins_Pipeline_Test$ ls
Jenkinsfile
```
---
<br><br><br>

# Jenkins Pipeline Job 생성
## 새로운 item을 누른다.
![img](/assets/category/Jenkins/02/01.PNG)


## Pipeline을 선택한 후 OK
![img](/assets/category/Jenkins/02/02.PNG)

---
<br><br><br>