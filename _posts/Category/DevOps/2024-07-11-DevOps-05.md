---
layout:     BLACKCODE
title: "Jenkins CI/CD 원격서버(Kubernetes) SpringBoot 배포 [작성중]"
subtitle:   ""
description: ""
date: 2024-07-11 01:00:00 +0900
author:     "김민서"
header-img: "assets/owner/hero/home-bg.jpg"
header-video: "assets/video/metrix.mp4"
thumbnail: /assets/owner/blog/thumbs/thumb01.png
tags: [Jenkins]
category: [DEVOPS]
# comments: false
# share: false
---
# 목차
1. Infra 환경 구성
2. [SpringBoot Project Local Test](https://iiblackcode.github.io/writing/DevOps-03/)
3. [Remote Server 구성](https://iiblackcode.github.io/writing/DevOps-03/)
4. [Jenkins Remote Server 등록](https://iiblackcode.github.io/writing/DevOps-04/)
5. [Jenkins Repository 연동](https://iiblackcode.github.io/writing/DevOps-03/)
6. Jenkins 배포 Pipeline 구성
7. Jenkins Build
8. SpringBoot 서버 종료(Docker)

---
<br><br><br>

# 1. Infra 환경 구성
![img](/assets/category/DevOps/05/00.png)

---
<br><br><br>

# 2. [SpringBoot Project Local Test](https://iiblackcode.github.io/writing/DevOps-03/)

---
<br><br><br>

# 3. [Remote Server 구성](https://iiblackcode.github.io/writing/DevOps-03/)
```shell
sudo apt update
sudo apt install openjdk-17-jdk -y
sudo apt install maven -y
sudo apt install gradle
``` 
[Kubernetes 설치 참고](https://iiblackcode.github.io/writing/kubernetes-01/)

---
<br><br><br>

# 4. [Jenkins Remote Server 등록](https://iiblackcode.github.io/writing/DevOps-04/)

---
<br><br><br>

# 5. [Jenkins Repository 연동](https://iiblackcode.github.io/writing/DevOps-03/)

---
<br><br><br>

# 6. Jenkins 배포 Pipeline 구성
## 1. Dashboard 에서 작업할 job을 선택합니다.
![img](/assets/category/DevOps/04/2-1.png)
> 본 설명에서 Springboot-Demo-war 선택

## 2. 구성을 선택합니다.
![img](/assets/category/DevOps/04/2-2.png)

## 3. Build Steps 구성

build를 하기위한 방식은 여러방식이 있는듯 하다. 각자 환경에 맞게 선택하면 된다.
### 1). script 명령어를 통해 build
    
```shell
# gradlew 파일의 위치로 이동
cd demo-war

ls -l

chmod +x gradlew
./gradlew clean build --info
```

![img](/assets/category/DevOps/04/build_01.png)

### 2). [작성 예정]

## 4. 빌드 후 조치

`빌드 후 조치 추가` > `Send build artifacts over SSH` 선택
![img](/assets/category/DevOps/04/build-after_01.png)
    
### SSH Server
- Name : 등록한 원격 서버를 선택한다.
- `고급`을 눌러 `Verbose output in console`에 체크해준다.

    배포단계에서 상세로그를 확인할 수 있다. 

    ![img](/assets/category/DevOps/04/build-after_02.png)

### Transfers
- Source files : 
    - <프로젝트명>/<파일경로>/<.war or .jar> 파일형식으로 build된 파일경로를 입력한다.
    - 파일이 한개인 경우 **/*.war 와 같은 형식으로 입력하면 된다. 
    - SpringBoot build시 plain을 생성하게 되므로 확인필요.
- Remove prefix : 
    - <프로젝트명>/<파일경로>/
    - 비워두면 쓸대없는 디렉토리가 생성된다고 한다. (직접 해보진 않음)
- Remote directory : 
    - 원격 서버에서 배포할 디렉토리를 입력한다.
    - 단, 경로가 맞지않으면 자동으로 생성하지 않아 실패하게됨 
- Exec command : 
    - war나 jar파일을 원격서버로 전달하고 해당 경로에서 진행할 작업 script를 작성한다.
    - 바로 서버를 구동하기 위해 아래와 같이 명령어를 넣어주었다.
        ```shell
        java -jar -Dserver.port=6060 demo-war-0.0.1-SNAPSHOT.war
        ```
        이렇게 명령어를 작성하는 경우 Build가 끝나지 않으므로 구동 후 빠져나오는 옵션설정을 해줘야 한다.

```shell
# java -jar -Dserver.port=6060 demo-war-0.0.1-SNAPSHOT.war
pwd
cd was/SpringBoot
pwd

# Docker build 명령어 수행
sudo docker build -t iiblackcode/springboot-6060 .

# 생성된 Docker image 확인
sudo docker images

# Docker hub login or ACR 등록
sudo docker login

# Docker hub로 이미지 push
sudo docker push iiblackcode/springboot-6060

# sudo docker run -it -d -p 6060:8080 springboot-6060
# sudo docker ps -a
```

- service.yaml 파일

```shell
apiVersion: v1
kind: Service
metadata:
  name: springboot-service
spec:
  selector:
    app: springboot
  ports:
  - protocol: TCP
    port: 8080          # 외부에서 접근할 포트
    targetPort: 8080    # Pod 내 컨테이너의 포트
    nodePort: 30061     # NodePort를 유효 범위 내로 설정
  type: LoadBalancer  
  # type: NodePort
```

- deployment.yaml 파일

```shell
apiVersion: apps/v1
kind: Deployment
metadata:
  name: springboot-deployment
spec:
  replicas: 3
  selector:
    matchLabels:
      app: springboot
  template:
    metadata:
      labels:
        app: springboot
    spec:
      containers:
      - name: springboot
        image: iiblackcode/springboot-6060:latest
        ports:
        - containerPort: 8080
``` 

###  작성 참고
![img](/assets/category/DevOps/04/build_02.png)
작성 완료 후 저장버튼을 눌러 저장을 완료한다.


---
<br><br><br>

# 7. Jenkins Build

---
<br><br><br>

# 8. SpringBoot 서버 종료

---
<br><br><br>